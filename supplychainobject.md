# OpenRTB SupplyChain object


## Аннотация

В рамках более широких усилий по устранению возможности получения прибыли от недействительного трафика, мошенничества с рекламой и поддельного инвентаря в открытой экосистеме цифровой рекламы объект SupplyChain позволяет покупателям видеть все стороны, которые продают или перепродают данный запрос на покупку. Этот объект расширения можно использовать с OpenRTB 2.5. Он был официально добавлен в исходный объект для OpenRTB 2.6 и 3.0.


## Введение

Ads.txt чрезвычайно успешно позволяет издателям и производителям приложений определять, кто уполномочен продавать определенный набор показов через программный рынок. Однако Ads.txt не делает никаких попыток раскрыть или авторизировать все стороны, которые участвуют в сделке по продаже этих показов. Эта информация может быть важна для покупателей по ряду причин, включая прозрачность цепочки поставок, уверенность в том, что все посредники являются организациями, с которыми покупатель хочет заключать сделки, и что инвентарь приобретается как можно более напрямую. Реализация должна быть максимально прозрачной для покупателей. Они должны иметь возможность легко понять, кто участвует в продаже того или иного товарно-материального запаса.


## Реализация

Объект SupplyChain состоит в основном из набора узлов, где каждый узел представляет конкретную организацию, участвующую в сделках с товарно-материальными запасами. Вся цепочка узлов от начала до конца представляет все сущности, которые участвуют в прямом потоке оплаты за товарно-материальные ценности. Будущие версии спецификации могут также включать в себя сущности, которые участвуют в транзакции, но не участвуют в оплате.


## Определение узла

Узел содержит два необходимых свойства: идентификатор рекламной системы (asi) и идентификатор продавца (sid). Идентификатор рекламной системы - это доменное имя рекламной системы. Идентификатор продавца используется для идентификации продавца инвентаря, которому рекламная система платит за этот инвентарь. Идентификатор рекламной системы и идентификатор продавца должны быть теми же значениями, которые указаны в файлах ads.txt. Недопустимо, чтобы идентификатор продавца представлял несколько сущностей. Каждый идентификатор продавца должен быть связан только с одной организацией, которая получает оплату за инвентарь, проданный с этим идентификатором продавца. Продающая организация может иметь несколько идентификаторов продавца в рамках рекламной системы.


## OpenRTB Объект: SupplyChain

Этот объект представляет собой как звенья цепи поставок, так и индикатор того, завершена ли цепь поставок.

Объект SupplyChain должен быть включен в атрибут BidRequest.Source.schain в OpenRTB 2.6 или более поздней версии, а также в атрибут BidRequest.Source.ext.schain в OpenRTB 2.5. Для OpenRTB 2.4 и более ранних версий следует использовать атрибут BidRequest.ext.schain.

Объект SupplyChain включает в себя следующие атрибуты:


<table>
  <tr>
   <td><strong>Атрибут</strong></td>
   <td><strong>Тип</strong></td>
   <td><strong>Описание</strong></td>
  </tr>
  <tr>
   <td>complete</td>
   <td>integer; обязательный</td>
   <td>Флаг, указывающий, содержит ли цепочка все узлы, участвующие в транзакции, ведущие к владельцу сайта, приложения или другого носителя инвентаря, где 0 = нет, 1 = да.</td>
  </tr>
  <tr>
   <td>nodes</td>
   <td>object array; обязательный</td>
   <td>Массив объектов SupplyChainNode в порядке следования цепочки. В полной цепочке поставок первый узел представляет собой начальную рекламную систему и идентификатор продавца, участвующего в транзакции, то есть владельца сайта, приложения или другого носителя. В неполной цепочке поставок он представляет первый известный узел. Последний узел представляет организацию, отправляющую данный запрос на покупку.</td>
  </tr>
  <tr>
   <td>ver</td>
   <td>string; обязательный</td>
   <td>Версия используемой спецификации цепочки поставок в формате "major.minor". Например, для версии 1.0 спецификации используйте строку "1.0". </td>
  </tr>
  <tr>
   <td>ext</td>
   <td>object; опциональный</td>
   <td>Заполнитель для расширений этого объекта, специфичных для рекламной системы. </td>
  </tr>
</table>


## OpenRTB Объект: SupplyChainNode

Этот объект связан с объектом SupplyChain в виде массива узлов. Эти узлы определяют идентификатор организации, участвующей в цепочке поставок заявки на участие в торгах. Объект SupplyChainNode содержит следующие атрибуты:


<table>
  <tr>
   <td><strong>Атрибут</strong></td>
   <td><strong>Тип</strong></td>
   <td><strong>Описание</strong></td>
  </tr>
  <tr>
   <td>asi</td>
   <td>string; обязательный</td>
   <td>Каноническое доменное имя системы SSP, Exchange, Header Wrapper и т. д., к которой подключаются участники торгов. Это может быть операционный домен системы, если он отличается от родительского корпоративного домена, чтобы облегчить WHOIS и обратный поиск IP-адресов для установления четкой принадлежности системы делегата. Это должно быть то же значение, которое используется для идентификации продавцов в файле ads.txt, если он существует.</td>
  </tr>
  <tr>
   <td>sid</td>
   <td>string; обязательный</td>
   <td>Идентификатор, связанный с учетной записью продавца или посредника в рекламной системе. Он должен содержать то же значение, которое используется в транзакциях (т.е. в запросах ставок OpenRTB) в поле, указанном SSP/биржей. Как правило, в OpenRTB это publisher.id. Для OpenDirect это обычно идентификатор организации издателя. Длина должна быть ограничена 64 символами.</td>
  </tr>
  <tr>
   <td>rid</td>
   <td>string; опциональный</td>
   <td>OpenRTB RequestId запроса, выданного этим продавцом.</td>
  </tr>
  <tr>
   <td>name</td>
   <td>string; опциональный</td>
   <td>Название компании (юридического лица), которая получает оплату за товар, проданный по данному идентификатору продавца. Это значение является необязательным и НЕ должно быть включено, если оно существует в файле sellers.json рекламной системы.</td>
  </tr>
  <tr>
   <td>domain</td>
   <td>string; опциональный</td>
   <td>Доменное имя организации, представленной этим узлом. Это значение необязательно и не должно включаться, если оно существует в файле sellers.json рекламной системы.</td>
  </tr>
  <tr>
   <td>hp</td>
   <td>integer; обязательный</td>
   <td>Указывает, будет ли этот узел участвовать в потоке оплаты за инвентарь. Если установлено значение 1, рекламная система в поле asi платит продавцу в поле sid, который отвечает за оплату предыдущего узла в цепочке. При значении 0 этот узел не участвует в потоке оплаты за товарные запасы. В версии 1.0 SupplyChain это свойство всегда должно быть равно 1. Оно явно требуется для включения, так как ожидается, что в будущих версиях спецификации появятся узлы, не участвующие в обработке платежей. Исполнители должны убедиться, что они поддерживают это поле и распространяют его дальше при создании объектов SupplyChain в запросах заявок, отправляемых в нижестоящую рекламную систему.</td>
  </tr>
  <tr>
   <td>ext</td>
   <td>object; опциональный</td>
   <td>Заполнитель для расширений этого объекта, специфичных для рекламной системы.</td>
  </tr>
</table>

Обратите внимание, что поля asi и domain должны заполняться только каноническими доменами рекламной системы или продавца, и это должны быть те же домены, которые используются в OpenRTB Site .domain, sellers.json, ads.txt для согласования.  Полные URL (или даже схемы, например, http:// или https://) не должны использоваться.  Для целей данного документа "корневой домен" определяется как "публичный суффикс" плюс одна строка в имени. Разработчики должны использовать список публичных суффиксов [16] для определения корневого домена.

Valid examples:
example.com
example.co.uk

Неверные примеры:
http://example.com
https://example.com/about-us.html


## Детали реализации

Недопустимо, чтобы торговец копировал объект SupplyChain от предыдущего продавца в свою заявку на этот инвентарь, не вставив при этом свой узел в цепочку. Если торговец не вставляет себя в цепочку, его заявка не должна содержать объект SupplyChain.

Если продавец перепродает товар, который ранее не содержал объект SupplyChain, он должен сам создать объект SupplyChain, отметить атрибут "complete" значением 0 и вставить свой узел в массив "nodes".

Если продавец перепродает инвентарь, имеющий объект SupplyChain, он должен скопировать существующий объект, сохранив исходное значение "complete", и добавить свой узел в конец массива "nodes".

Если это запрос на участие в торгах для данного инвентаря, объект SupplyChain должен быть создан с атрибутом "complete", установленным на 1, а информация о нем должна быть единственным узлом в массиве "nodes".


## Примеры:

## Действительные, полные SupplyChain объектов

### Образец заявки на участие в торгах. (BidRequest1, seller = “directseller.com”):


```
"bidrequest" : {
  "id": "BidRequest1",
  "app": {
    "publisher": {
      "id": "00001"
    }
  }
  "source": {
    "ext": {
      "schain": {
        "ver":"1.0",
        "complete": 1,
        "nodes": [
          {
            "asi":"directseller.com",
            "sid":"00001",
            "rid":"BidRequest1",
            "hp":1
          }
        ]     
      } 
    }
  }
}
```

### Образец перепродажи BidRequest1 (BidRequest2, seller = “reseller.com”):

```
"bidrequest" : {
  "id": "BidRequest2",
  "app": {
    "publisher": {
      "id": "aaaaa"
    }
  }
  "source": {
    "ext": {
      "schain": {
        "ver":"1.0",
        "complete": 1,
        "nodes": [
          {
            "asi":"directseller.com",
            "sid":"00001"
            "rid":"BidRequest1",
            "hp":1
          },
          {
            "asi":"reseller.com",
            "sid":"aaaaa",
            "rid":"BidRequest2",
            "hp":1
          }
        ]     
      } 
    }
  }
}

```

## Valid, incomplete SupplyChain objects

### Образец запроса заявки от рекламной системы, которая не поддерживает объект SupplyChain. (BidRequest3, seller = “directseller.com”):

```
"bidrequest" : {
  "id": "BidRequest3",
  "app": {
    "publisher": {
      "id": "00001"
    }
  }
  "source": {
    "ext": {
    }
  }
}
```

### Образец перепродажи BidRequest3 рекламной системой, поддерживающей объект SupplyChain. (BidRequest4, seller = “reseller.com”):


```
"bidrequest" : {
  "id": "BidRequest4",
  "app": {
    "publisher": {
      "id": "aaaaa"
    }
  }
  "source": {
    "ext": {
      "schain": {
        "ver":"1.0",
        "complete": 0,
        "nodes": [
          {
            "asi":"reseller.com",
            "sid":"aaaaa",
            "rid":"BidRequest4",
            "hp":1
          }
        ]     
      } 
    }
  }
}
```
## SupplyChain для запросов, не относящихся к OpenRTB
Поскольку вышеприведенная документация содержит указания только для транзакций, осуществляемых по протоколу OpenRTB, в этом разделе описан стандартный способ передачи информации SupplyChain через тег, а не OpenRTB. Такая ситуация чаще всего возникает, когда рекламная система предоставляет тег, который может быть вставлен в рекламный сервер, видеоплеер, поставщик SSAI и т. д. для инициирования запроса рекламы к рекламной системе.

**Цели сериализации:**
* Поддержка всех свойств объекта SupplyChain
* Минимизация необходимости кодирования URL-адресов сериализованных данных
* Поддержка совместимости с будущими изменениями в SupplyChain

**Сценарии использования:**
В этом приложении описана методология определения хорошо структурированной строки, содержащей данные SupplyChain, которые могут быть получены с помощью стандартных для отрасли "пар ключ-значение".

Если принимающая рекламная система обрабатывает запрос на основе тегов и формирует исходящий OpenRTB-запрос к другой рекламной системе, то выполняется следующая процедура.  Сначала она должна разобрать полученные данные SupplyChain, как описано ниже, создать и заполнить полученными данными объект SupplyChain.  Наконец, рекламная система должна добавить свою собственную информацию к массиву в объекте.

Если принимающая рекламная система обрабатывает запрос на основе тегов и формирует исходящий запрос на основе тегов для другой рекламной системы, то выполняется следующая процедура:  Она должна добавить узел для себя к уже существующей строке, не изменяя никакой предшествующей информации в полученной строке.

Если принимающая рекламная система обрабатывает запрос OpenRTB и формирует исходящий запрос на основе тегов для другой рекламной системы, то выполняется следующая процедура:  Она должна разобрать и сериализовать данные в полученном объекте SupplyChain и сериализовать их, как указано ниже. Он должен сформировать для себя строку, соответствующую спецификации, а затем добавить ее к предыдущей строке.

**Получение SupplyChain в рекламную систему через теги или URL-адреса**
Рекламные системы должны поддерживать параметр в тегах объявлений или URL-адресах VAST для приема строковой сериализации SupplyChain. Рекомендуется, чтобы этот параметр был "schain".

Например, на рекламном сервере может быть такой формат тегов для отображения рекламы:

```
<script src="https://ads.exchange1.com/srv?pid=194&sz=300x250&plid=2842181&schain=[SUPPLYCHAIN GOES HERE]"></script>
```

или в формате VAST URL, например:

```
https://ads.exchange1.com/srv?pid=194&sz=v&plid=2842185&schain=[SUPPLYCHAIN GOES HERE]
```

**Отправка SupplyChain в другие теги или URL-адреса**
У рекламной системы может возникнуть необходимость передать объект SupplyChain другому рекламному тегу или VAST URL. Это может произойти независимо от того, получена ли информация SupplyChain рекламной системой через OpenRTB или через строку, сериализованную SupplyChain, как описано выше. Для этой цели рекомендуется, чтобы рекламные системы поддерживали макрос (например, $SCHAIN) для вывода строковой сериализованной SupplyChain. Выходом этого макроса должна быть строковая сериализованная SupplyChain с добавлением узла рекламной системы.

### Сериализация объекта OpenRTB SupplyChain в параметр URL
Предлагаемый параметр URL: schain

### Формат сериализации
Сериализация состоит из двух элементов: свойства SupplyChainObject и массива SupplyChainNode. Эти два элемента разделяются символом bang ("!").

```{SupplyChainObject}!{SupplyChainNode array}```

### SupplyChainObject properties
There are two properties in a SupplyChain object; version and complete. These two values must be included at the beginning of the serialized value and must be separated by a comma (“,”).

```ver,complete```

### Массив свойств SupplyChainNode
После свойств объекта SupplyChainObject необходимо указать каждый узел цепочки поставок. Свойства объекта SupplyChainNode должны быть разделены запятой (","), а если узлов несколько, то каждый из них должен быть разделен символом bang ("!").

Порядок свойств следующий:

```asi,sid,hp,rid,name,domain,ext```

Содержимое свойства ext специфично для обмена, в этом документе не делается попыток указать метод сериализации значений для этого объекта.

Необязательные значения свойств SupplyChainNode могут быть опущены, а концевые разделители могут быть исключены по желанию.

Пример:
```exampleexchange.com,12345,1,,,```

или

```exampleexchange.com,12345,1```

Если значения в любом из свойств требуют кодировки URL (см. RFC 3986 или пост в Википедии) или содержат запятую или символ bang, они должны быть закодированы в URL. Запятая, используемая для разделения свойств, не должна быть закодирована.

Example:
```exampleexchange.com,123%2CB,1,,,```

Это представляет собой сид "123,B" на сайте exampleexchange.com, который обрабатывает платежи.

### Примеры

### Single Hop - Chain Complete

**SupplyChain**
``` 
"schain" : {
    "ver":"1.0",
    "complete":1,
    "nodes":[
        {
            "asi":"exchange1.com",
            "sid":"1234",
            "hp":1,
            "rid":"bid-request-1",
            "name":"publisher",
            "domain":"publisher.com"
        }
    ]
}
``` 

**Сериализованное значение**
``` 
1.0,1!exchange1.com,1234,1,bid-request-1,publisher,publisher.com
``` 

### Single Hop - цепочка завершена, необязательные поля отсутствуют

**SupplyChain**
```
"schain" : {
    "ver":"1.0",
    "complete":1,
    "nodes" : [
        {
            "asi":"exchange1.com",
            "sid":"1234",
            "hp":1
        }
    ]
}
```

**Сериализованное значение**
```1.0,1!exchange1.com,1234,1,,,```

### Multiple Hops - Со всеми свойствами в комплекте

**SupplyChain**
```
"schain" : {
    "ver": "1.0",
    "complete" : 1,
    "nodes" : [
        {
            "asi":"exchange1.com",
            "sid":"1234",
            "hp":1,
            "rid":"bid-request-1",
            "name":"publisher",
            "domain":"publisher.com"
        },
        {
            "asi":"exchange2.com",
            "sid":"abcd",
            "hp":1,
            "rid":"bid-request-2",
            "name":"intermediary",
            "domain":"intermediary.com"
        }
    ]
}
```
**Сериализованное значение**
```1.0,1!exchange1.com,1234,1,bid-request-1,publisher,publisher.com!exchange2.com,abcd,1,bid-request2,intermediary,intermediary.com```

### Multiple Hops - Цепочка завершена, необязательные поля отсутствуют

**SupplyChain**
```
"schain" : {
    "ver":"1.0",
    "complete":1,
    "nodes":[
        {
            "asi":"exchange1.com",
            "sid":"1234",
            "hp":1
        },
        {
            "asi":"exchange2.com",
            "sid":"abcd",
            "hp":1
        }
    ]
}
```

**Сериализованное значение**
```1.0,1!exchange1.com,1234,1,,,!exchange2.com,abcd,1,,,```

### Multiple Hops Expected - Цепь неполная

**SupplyChain**
```
"schain" : {
    "ver":"1.0",
    "complete" :0,
    "nodes":[
        {
            "asi":"exchange2.com",
            "sid":"abcd",
            "hp":1
        }
    ]
}
```

**Сериализованное значение**
```1.0,0!exchange2.com,abcd,1,,,```

### Single Hop - Цепочка Полная, закодированные значения

**SupplyChain**
```
"schain" : {
    "ver":"1.0",
    "complete":1,
    "nodes":[
        {
            "asi":"exchange1.com",
            "sid":"1234!abcd",
            "hp":1,
            "rid":"bid-request-1",
            "name":"publisher, Inc.",
            "domain":"publisher.com"
        }
    ]
}
```

**Сериализованное значение**
```1.0,1!exchange1.com,1234%21abcd,1,bid-request-1,publisher%2c%20Inc.,publisher.com```

